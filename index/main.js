"use strict";const r=require("siyuan");async function a(){let t=g();if(t==null){await r.serverApi.pushErrMsg(null,"你需要先打开一个文档",2e3);return}let[n,i]=await w(t),e="";e=await c(n,i,e),e!=""?b(t,e):await r.serverApi.pushErrMsg(null,"当前文档下无子文档",2e3)}async function w(t){let n=await r.serverApi.sql(`SELECT * FROM blocks WHERE id = '${t}'`),i=n[0].box,e=n[0].path;return[i,e]}function g(){var t;return(t=document.querySelector(".layout__wnd--active .protyle.fn__flex-1:not(.fn__none) .protyle-background"))==null?void 0:t.getAttribute("data-node-id")}async function m(t,n){let i=r.serverApi.request("/api/filetree/listDocsByPath",{notebook:t,path:n}),e=await r.serverApi.parseBody(i);return e==null?[]:e.files}function v(t,n){return t==""||t==null?n?"📑":"📄":String.fromCodePoint(parseInt(t,16))}async function c(t,n,i,e=0){let u=await m(t,n);e++;for(let o of u){let d=o.id,p=o.name.slice(0,-3),h=o.icon,l=o.subFileCount,f=o.path;for(let s=0;s<e;s++)i+="  ";i+=`* ${v(h,l!=0)}[${p}](siyuan://blocks/${d})
`,l>0&&(i=await c(t,f,i,e))}return i}async function b(t,n){await r.serverApi.prependBlock(t,"markdown",n)}class y extends r.Plugin{constructor(){super()}insertIcon(){this.el=document.createElement("div"),this.el.classList.add("toolbar__item","b3-tooltips","b3-tooltips__se"),this.el.setAttribute("aria-label","插入目录"),this.el.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 12H3"></path><path d="M16 6H3"></path><path d="M16 18H3"></path><path d="M18 9v6"></path><path d="M21 12h-6"></path></svg>',this.el.addEventListener("click",()=>{a()}),r.clientApi.addToolbarRight(this.el)}onload(){this.insertIcon(),this.registerCommand({command:"ic",shortcut:"ctrl+alt+i,command+option+e",description:"插入目录",callback:a})}onunload(){this.el.remove()}}module.exports=y;
